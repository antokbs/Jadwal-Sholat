#!/usr/bin/php
<?php
$vaProsess = shell_exec("pgrep -l -f -a murotal");
$vaProsess = explode("\n", $vaProsess);
$nProsess = 0;
foreach ($vaProsess as $value) {
  if (trim($value) !== "" && strpos($value, "sh -c") === false) {
    $nProsess++;
  }
}
if ($nProsess > 1) {
  echo ("Aplikasi Sudah Berjalan ....\n");
  die();
}
PlayMurotal();

// Memutar Murotal
function PlayMurotal()
{
  // Ambil Posisi Terakhir
  $cAyatTerakhir = "";
  $cFileAyat = GetData("ayat.txt");
  if (is_file($cFileAyat)) {
    $cAyatTerakhir = file_get_contents($cFileAyat);
    $va = json_decode($cAyatTerakhir, true);
    if (isset($va["ayat"])) {
      $cAyatTerakhir = $va["ayat"];
    }
  }

  // Folder Murotal
  $path = realpath($_SERVER['HOME'] . "/MP3/Alafasy");
  if (is_dir($path)) {
    $vaSurat = scandir($path);
    while (true) {
      // Kita Loop Surat nya
      foreach ($vaSurat as $surat) {
        if (substr($surat, 0, 1) !== "." && is_dir("$path/$surat")) {
          // Ambil Ayat Untuk Surat yang Aktif
          $vaAyat = GetAyat("$path/$surat");
          foreach ($vaAyat as $ayat) {
            $mp3 = "$path/$surat/$ayat";
            if (is_file($mp3)) {
              if ($cAyatTerakhir !== "" && $mp3 == $cAyatTerakhir) $cAyatTerakhir = "";

              if ($cAyatTerakhir == "") {
                CheckStatus();
                $vaData = ["ayat" => $mp3, "datetime" => time()];
                file_put_contents(GetData("ayat.txt"), json_encode($vaData));

                // Putar MP3
                exec("cvlc --play-and-exit '$mp3'");
              }
            }
          }
        }
      }
      $cAyatTerakhir = "";
    }
  } else {
    die("Folder Tidak Ditemukan ...");
  }
}

function GetAyat($path)
{
  $vaAyat = [];
  if (is_dir($path)) {
    $vaDir = scandir($path);
    foreach ($vaDir as $file) {
      if (substr($file, 0, 1) !== "." && is_file("$path/$file")) {
        $ext = pathinfo($file, PATHINFO_EXTENSION);
        if (strtolower($ext) == "mp3") {
          $vaAyat[] = $file;
        }
      }
    }
  }
  return $vaAyat;
}

function CheckStatus()
{
  $cStatus = "stop";
  $cFile = GetData("status.txt");
  while (strpos($cStatus, "stop") !== false) {
    if (is_file($cFile)) {
      $cStatus = file_get_contents($cFile);
    } else {
      $cStatus = "start";
    }

    if (strpos($cStatus, "stop") !== false) {
      sleep(5);
    }
  }
}

function GetData($cFile = "")
{
  return dirname(__DIR__) . "/data/$cFile";
}
